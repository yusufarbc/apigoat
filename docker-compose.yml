services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: apigoat-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: apigoat123
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - apigoat-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # Web Interface
  web:
    build:
      context: ./web
      dockerfile: ../Dockerfile.api
    container_name: apigoat-web
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - PORT_WEB=8000
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - apigoat-network

  # API1 - Broken Object Level Authorization
  api1:
    build:
      context: ./API1
      dockerfile: ../Dockerfile.api
    container_name: apigoat-api1
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - PORT_API1=8001
      - JWT_KEY1=api1
      - mongoDBURL=mongodb://admin:apigoat123@mongodb:27017/apigoat?authSource=admin
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - apigoat-network

  # API2 - Broken Authentication
  api2:
    build:
      context: ./API2
      dockerfile: ../Dockerfile.api
    container_name: apigoat-api2
    restart: unless-stopped
    ports:
      - "8002:8002"
    environment:
      - PORT_API2=8002
      - JWT_KEY2=api2
      - mongoDBURL=mongodb://admin:apigoat123@mongodb:27017/apigoat?authSource=admin
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - apigoat-network

  # API3 - Broken Object Property Level Authorization
  api3:
    build:
      context: ./API3
      dockerfile: ../Dockerfile.api
    container_name: apigoat-api3
    restart: unless-stopped
    ports:
      - "8003:8003"
    environment:
      - PORT_API3=8003
      - JWT_KEY3=api3
      - mongoDBURL=mongodb://admin:apigoat123@mongodb:27017/apigoat?authSource=admin
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - apigoat-network

  # API4 - Unrestricted Resource Consumption
  api4:
    build:
      context: ./API4
      dockerfile: ../Dockerfile.api
    container_name: apigoat-api4
    restart: unless-stopped
    ports:
      - "8004:8004"
    environment:
      - PORT_API4=8004
      - JWT_KEY4=api4
      - mongoDBURL=mongodb://admin:apigoat123@mongodb:27017/apigoat?authSource=admin
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - apigoat-network

  # API5 - Broken Function Level Authorization
  api5:
    build:
      context: ./API5
      dockerfile: ../Dockerfile.api
    container_name: apigoat-api5
    restart: unless-stopped
    ports:
      - "8005:8005"
    environment:
      - PORT_API5=8005
      - JWT_KEY5=api5
      - mongoDBURL=mongodb://admin:apigoat123@mongodb:27017/apigoat?authSource=admin
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - apigoat-network

  # API6 - Unrestricted Access to Sensitive Business Flows
  api6:
    build:
      context: ./API6
      dockerfile: ../Dockerfile.api
    container_name: apigoat-api6
    restart: unless-stopped
    ports:
      - "8006:8006"
    environment:
      - PORT_API6=8006
      - JWT_KEY6=api6
      - mongoDBURL=mongodb://admin:apigoat123@mongodb:27017/apigoat?authSource=admin
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - apigoat-network

  # API7 - Server Side Request Forgery
  api7:
    build:
      context: ./API7
      dockerfile: ../Dockerfile.api
    container_name: apigoat-api7
    restart: unless-stopped
    ports:
      - "8007:8007"
    environment:
      - PORT_API7=8007
      - JWT_KEY7=api7
      - OPENWEATHER_API_KEY=2ee846af58955a6f94b6ed6b16fdb176
    networks:
      - apigoat-network

  # API8 - Security Misconfiguration
  api8:
    build:
      context: ./API8
      dockerfile: ../Dockerfile.api
    container_name: apigoat-api8
    restart: unless-stopped
    ports:
      - "8008:8008"
    environment:
      - PORT_API8=8008
      - JWT_KEY8=api8
      - mongoDBURL=mongodb://admin:apigoat123@mongodb:27017/apigoat?authSource=admin
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - apigoat-network

  # API9 - Improper Inventory Management
  api9:
    build:
      context: ./API9
      dockerfile: ../Dockerfile.api
    container_name: apigoat-api9
    restart: unless-stopped
    ports:
      - "8009:8009"
    environment:
      - PORT_API9=8009
      - JWT_KEY9=api9
    networks:
      - apigoat-network

  # API10 - Unsafe Consumption of APIs
  api10:
    build:
      context: ./API10
      dockerfile: ../Dockerfile.api
    container_name: apigoat-api10
    restart: unless-stopped
    ports:
      - "8010:8010"
    environment:
      - PORT_API10=8010
      - JWT_KEY10=api10
    networks:
      - apigoat-network

networks:
  apigoat-network:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
